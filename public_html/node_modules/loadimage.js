// Importamos el modulo para subir ficheros
var fs = require('fs'),
        request = require('request'),
        sizeOf = require('image-size'),
        randomstring = require("randomstring"),
        Url = require('url'),
        Path = require('path');

var relative_path = "uploaded-files/images/";

exports.Uploads = function(req, res) {
    var tmp_path = req.files.inputimage.path;
    var name = req.files.inputimage.name.replace(/[^a-zA-Z0-9\.]/g, '');
    var dimensions = sizeOf(tmp_path);
    // Ruta donde colocaremos las imagenes
    var target_path = './public/' + relative_path + name;
    // Comprobamos que el fichero es de tipo imagen
    if (req.files.inputimage.type.indexOf('image') == -1) {
        res.send('El fichero que deseas subir no es una imagen');
    } else {
        // Movemos el fichero temporal tmp_path al directorio que hemos elegido en target_path
        fs.rename(tmp_path, target_path, function(err) {
            if (err) {
                res.send(JSON.parse({error: 'Error on upload file'}));
                throw err;
            }
            ;
            // Eliminamos el fichero temporal
            fs.unlink(tmp_path, function() {
                if (err) {
                    throw err;
                }
                ;
                res.send({name: name, src: relative_path + name, width: dimensions.width, height: dimensions.height});
            });
        });
    }
};

exports.UpImageFromUrl = function(req, res) {
    var name = randomstring.generate({
        length: 20,
        charset: 'alphanumeric'
    });

    var extension = Path.extname(Url.parse(req.body.urlimageinput).pathname);

    name = name + extension;
    var file = request(req.body.urlimageinput).pipe(fs.createWriteStream('./public/uploaded-files/images/' + name));

    file.on('close', function() {
        var dimensions = sizeOf("./public/uploaded-files/images/" + name);
        res.send({name: name, src: relative_path + name, width: dimensions.width, height: dimensions.height});
    });
}