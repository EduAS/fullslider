var fs = require('fs'),
        path = require('path'),
        open = require('open'),
        spawn = require('child_process').spawn;

var parentDir = path.resolve(process.cwd(), '.');

exports.toPDF = function(req, res) {
    var decktape = __dirname + '\\decktape\\decktape-fullslider.js';
    var phantomjs = __dirname + '\\phantomjs.exe';

    var pdf_name = 'public/tmp_files/' + req.body.title + '.pdf';

    var childArgs = [
        decktape,
        "file:///" + parentDir + "/public/app/components/reveal.js/index.html",
        pdf_name
    ];

    fs.writeFile("public/tmp_files/params", req.body.slides, function(err) {
        if (err) {
            res.send({end_code: err});
            return console.log(err);
        }
        var child = spawn(phantomjs, childArgs);

        child.stdout.on('data', function(data) {
            console.log('stdout: ' + data);
        });
        child.stderr.on('data', function(data) {
            console.log('stderr: ' + data);
        });
        child.on('close', function(code) {
            console.log('child process exited with code ' + code);
            res.send({end_code: code});
        });
    });

};


exports.viewPresentation = function(req, res) {
    var buf = new Buffer(req.body.slides);
    var slides64 = buf.toString("base64");
    var title = req.body.title;

    var filename = parentDir + "/public/app/components/reveal.js/index.html";

    open(filename, function(err) {
        if (err) {
            throw err
        }
        res.send({end: 0});
    });
};
