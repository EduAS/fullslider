var fs = require('fs'),
        path = require('path'),
        open = require('open'),
        spawn = require('child_process').spawn;

var parentDir = path.resolve(process.cwd(), '.');

rmDir = function(dirPath) {
    try {
        var files = fs.readdirSync(dirPath);
    }
    catch (e) {
        return;
    }
    if (files.length > 0)
        for (var i = 0; i < files.length; i++) {
            var filePath = dirPath + '/' + files[i];
            if (fs.statSync(filePath).isFile())
                fs.unlinkSync(filePath);
        }
};

exports.toPDF = function(req, res) {
    var decktape = __dirname + '/decktape/decktape-fullslider.js';
    var phantomjs = __dirname + '/phantomjs.exe';

    var pdf_name = 'public/tmp_files/' + req.body.title + '.pdf';

    var childArgs = [
        decktape,
        "file:///" + parentDir + "/public/app/components/reveal.js/index.html",
        pdf_name
    ];

    //Remove files in tmp_files folder
    rmDir("public/tmp_files/");

    fs.writeFile("public/tmp_files/params", req.body.slides, function(err) {
        if (err) {
            res.send({end_code: err});
            return console.log(err);
        }
        var child = spawn(phantomjs, childArgs);

        child.stdout.on('data', function(data) {
            console.log('stdout: ' + data);
        });
        child.stderr.on('data', function(data) {
            console.log('stderr: ' + data);
        });
        child.on('close', function(code) {
            console.log('child process exited with code ' + code);
            res.send({end_code: code});
        });
    });

};


exports.exportPresentation = function(req, res) {
    fs.writeFile("public/tmp_files/params", req.body.slides, function(err) {
        if (err) {
            res.send({end_code: err});
            return console.log(err);
        }
        res.send({end_code: 0});

    });
};


exports.getPresentation = function(req, res) {
    fs.readFile('public/tmp_files/params', "utf-8", function(err, data) {
        if (err) {
            throw err;
            res.send({end_code: err});
        }
        res.send({end_code: 0, slides: data});
    });
};

exports.downloadPresentation = function(req, res) {
    //Remove files in tmp_files folder
    rmDir("public/tmp_files/");
    
    fs.writeFile("public/tmp_files/" + req.body.name, req.body.file, function(err) {
        if (err) {
            res.send({end_code: err});
            return console.log(err);
        }
        res.send({end_code: 0, file_url: "tmp_files/" + req.body.name});

    });
};
